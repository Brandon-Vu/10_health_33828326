<!DOCTYPE html>
<html>
<head>
  <title>Meal Dashboard</title>
  <style>
    body { font-family: Arial, sans-serif; margin: 2rem; }
    h2 { color: #2c3e50; }
    ul { list-style-type: none; padding-left: 0; }
    li { margin: 0.5rem 0; }
    label { display: block; margin: 0.5rem 0; }
    input { margin-left: 0.5rem; }
    form.inline { display: inline; }
  </style>
</head>
<body>

  <h2>Welcome, <%= session.user.username %>!</h2>
  <p>You’ve logged <%= todaySummary.mealCount || 0 %> meal(s) today, totaling <%= todaySummary.totalCalories || 0 %> calories.</p>

  <h3>Weekly Summary</h3>
  <p>In the past 7 days, you’ve logged <%= weekSummary.mealCount || 0 %> meal(s), totaling <%= weekSummary.totalCalories || 0 %> calories.</p>

  <h3>Your Logged Meals</h3>
  <ul>
    <% if (meals.length === 0) { %>
      <li>No meals logged yet.</li>
    <% } else { %>
      <% meals.forEach(meal => { %>
        <li>
          <strong><%= meal.meal_name %></strong> —
          <%= meal.calories %> calories on
          <%= new Date(meal.meal_date).toDateString() %>

          <a href="/meals/edit/<%= meal.id %>">Edit</a>

          <form class="inline" action="/meals/delete/<%= meal.id %>" method="POST" onsubmit="return confirm('Delete this meal?');">
            <button type="submit">Delete</button>
          </form>
        </li>
      <% }) %>
    <% } %>
  </ul>

  <h3>Log a New Meal</h3>
  <form action="/meals" method="POST">
    <label>Meal Name:
      <input type="text" name="meal_name" id="mealInput" required autocomplete="off">
      <button type="button" onclick="fetchCalories()">Fetch Calories</button>
    </label>

    <p id="calorieDisplay" style="font-weight: bold;"></p>
    <input type="hidden" name="calories">

    <label>Date:
      <input type="date" name="meal_date" required>
    </label>

    <button type="submit">Add Meal</button>
  </form>

  <script>
    async function fetchCalories() {
      const mealInput = document.getElementById('mealInput');
      const calorieField = document.querySelector('input[name="calories"]');
      const calorieDisplay = document.getElementById('calorieDisplay');
      const name = mealInput.value.trim();

      if (!name) {
        calorieDisplay.textContent = 'Please enter a meal name.';
        calorieField.value = '';
        return;
      }

      try {
        const res = await fetch('/api/food-info?query=' + encodeURIComponent(name));
        const data = await res.json();

        if (res.ok && data.calories !== undefined) {
          calorieDisplay.textContent = `Estimated Calories: ${data.calories}`;
          calorieField.value = data.calories;
        } else {
          calorieDisplay.textContent = data.error || 'Could not estimate calories.';
          calorieField.value = '';
        }
      } catch (err) {
        console.error('Fetch error:', err);
        calorieDisplay.textContent = 'Error fetching calories.';
        calorieField.value = '';
      }
        if (res.ok && data.calories !== undefined) {
        calorieDisplay.textContent = `Estimated Calories: ${data.calories}`;
        calorieField.value = data.calories;
        } else {
        calorieDisplay.innerHTML = `Failed to fetch calories. <br><small>You can still log the meal manually.</small>`;
        calorieField.value = 0; 
        }
    }
  </script>

  <p><a href="/about">About</a> | <a href="/logout">Logout</a></p>

</body>
</html>